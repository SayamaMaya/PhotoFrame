<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>フォトフレームアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .frame-overlay {
            pointer-events: none;
            z-index: 10;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .frame-thumb {
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 8px;
        }
        .frame-thumb.active { border-color: #000; }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col items-center justify-center p-4 font-sans text-black">

    <div class="max-w-md w-full space-y-6">
        <div id="viewfinder" class="relative w-full aspect-square bg-black overflow-hidden border border-black">
            <!-- カメラ映像のみを表示 -->
            <video id="video-preview" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover"></video>
            
            <img id="frame-preview" class="absolute inset-0 w-full h-full object-contain frame-overlay hidden" src="" alt="">
            <img id="final-image" class="absolute inset-0 w-full h-full object-cover z-30 hidden" src="" alt="">

            <div id="start-overlay" class="absolute inset-0 flex items-center justify-center z-50 bg-black">
                <button type="button" id="start-camera-btn" class="px-8 py-4 border border-white text-white font-bold text-xs tracking-widest uppercase">
                    カメラを起動
                </button>
            </div>

            <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center z-40 bg-white hidden text-xs font-bold uppercase">
                <div class="flex flex-col items-center gap-3">
                    <div class="loader"></div>
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div id="frame-selector-section" class="hidden">
                <div class="flex justify-center gap-3">
                    <div id="thumb-1" class="frame-thumb w-12 h-12 overflow-hidden active">
                        <img id="img-thumb-1" class="w-full h-full object-contain" src="" alt="">
                    </div>
                    <div id="thumb-2" class="frame-thumb w-12 h-12 overflow-hidden">
                        <img id="img-thumb-2" class="w-full h-full object-contain" src="" alt="">
                    </div>
                </div>
            </div>

            <div id="capture-section" class="hidden">
                <button type="button" id="capture-btn" class="w-full py-4 bg-black text-white font-bold rounded-full text-sm">
                    撮影する
                </button>
            </div>

            <div id="result-section" class="hidden space-y-4">
                <p class="text-[10px] font-bold text-center text-neutral-400">画像を長押しで保存</p>
                <button type="button" id="share-x-btn" class="w-full py-4 border border-black text-black font-bold rounded-full text-sm">
                    Xに投稿
                </button>
                <button type="button" id="retake-btn" class="w-full text-center text-[10px] text-neutral-400 underline font-bold">
                    撮り直す
                </button>
            </div>
            <div class="space-y-4">
                <button type="button" id="subscribe-btn" class="w-full py-4 border border-black text-black font-bold rounded-full text-sm">
                    チャンネル登録
                </button>
            </div>
        </div>
    </div>

    <canvas id="merge-canvas" class="hidden"></canvas>

    <script>
        const video = document.getElementById('video-preview');
        const framePreview = document.getElementById('frame-preview');
        const finalImage = document.getElementById('final-image');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const startOverlay = document.getElementById('start-overlay');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const frameSelectorSection = document.getElementById('frame-selector-section');
        const captureSection = document.getElementById('capture-section');
        const resultSection = document.getElementById('result-section');
        const thumb1 = document.getElementById('thumb-1');
        const thumb2 = document.getElementById('thumb-2');
        const imgThumb1 = document.getElementById('img-thumb-1');
        const imgThumb2 = document.getElementById('img-thumb-2');

        let stream = null;
        let frameImg = new Image();
        let isFrameLoaded = false;

        const FRAME_URLS = [
            "https://www.dropbox.com/scl/fi/bc82xu2b1wgq96fi4edov/138_20260227111604.png?rlkey=4eduascd3lwkuuoc7tj6hy5v0&st=2jtuw7at&dl=1",
            "https://www.dropbox.com/scl/fi/r04b39y41jmt74ml4p4v1/138_20260227115018.png?rlkey=947jlmcsrs2tn14b2e6sigt0k&st=zebywf3d&dl=1"
        ];

        function getProxiedUrl(url) {
            return `https://images.weserv.nl/?url=${encodeURIComponent(url.replace(/dl=[01]/, "raw=1"))}`;
        }

        startCameraBtn.onclick = async () => {
            const success = await initCamera();
            if (success) {
                startOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('hidden');
                imgThumb1.src = getProxiedUrl(FRAME_URLS[0]);
                imgThumb2.src = getProxiedUrl(FRAME_URLS[1]);
                loadFrame(FRAME_URLS[0]);
            }
        };

        async function initCamera() {
            try {
                const constraints = { video: { facingMode: "environment", width: 1080, height: 1080 } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                return true;
            } catch (err) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    return true;
                } catch(e) { return false; }
            }
        }

        function loadFrame(url) {
            isFrameLoaded = false;
            const proxiedUrl = getProxiedUrl(url);
            frameImg = new Image();
            frameImg.crossOrigin = "anonymous";
            frameImg.onload = () => {
                framePreview.src = proxiedUrl;
                isFrameLoaded = true;
                loadingOverlay.classList.add('hidden');
                framePreview.classList.remove('hidden');
                frameSelectorSection.classList.remove('hidden');
                captureSection.classList.remove('hidden');
            };
            frameImg.src = proxiedUrl;
        }

        thumb1.onclick = () => { setActiveThumb(thumb1); loadFrame(FRAME_URLS[0]); };
        thumb2.onclick = () => { setActiveThumb(thumb2); loadFrame(FRAME_URLS[1]); };
        function setActiveThumb(t) { thumb1.classList.remove('active'); thumb2.classList.remove('active'); t.classList.add('active'); }

        captureBtn.onclick = () => {
            const canvas = document.getElementById('merge-canvas');
            const ctx = canvas.getContext('2d');
            const size = 1080;
            canvas.width = size;
            canvas.height = size;

            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, size, size);

            // カメラ映像を描画
            const vW = video.videoWidth;
            const vH = video.videoHeight;
            const min = Math.min(vW, vH);
            ctx.drawImage(video, (vW - min) / 2, (vH - min) / 2, min, min, 0, 0, size, size);

            // フレームを重畳
            if (isFrameLoaded) {
                ctx.drawImage(frameImg, 0, 0, size, size);
            }

            finalImage.src = canvas.toDataURL('image/jpeg', 0.9);
            finalImage.classList.remove('hidden');
            resultSection.classList.remove('hidden');
            
            frameSelectorSection.classList.add('hidden');
            captureSection.classList.add('hidden');
            video.classList.add('hidden');
            framePreview.classList.add('hidden');
        };

        retakeBtn.onclick = () => {
            finalImage.classList.add('hidden');
            resultSection.classList.add('hidden');
            frameSelectorSection.classList.remove('hidden');
            captureSection.classList.remove('hidden');
            framePreview.classList.remove('hidden');
            video.classList.remove('hidden');
        };

        document.getElementById('share-x-btn').onclick = () => {
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("フォトフレームで撮影しました！")}`, '_blank');
        };

        document.getElementById('subscribe-btn').onclick = () => {
            window.open(`https://youtube.com/@sayamamaya?si=q-cAMJk9BL6-H8BN`);
        };
        
        
    </script>
</body>
</html>
